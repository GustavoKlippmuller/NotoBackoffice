const urlActual=window.location.pathname,origen=window.location.origin,sale={idClient:idClient="",idEquipment:idEquipment="",verified_warranty:verified_warranty="",price:price="",date:date="",idUser:idUser="",metodoPagos:metodoPagos=[]};let aPagar=0,pagado=0,resto=99999;function iniciarApp(){cargarCombos(),configurarBotonAgregarMedioPago(),buscarNombreCliente()}function cargarCombos(){listarModelos(),listarMetodosPago()}async function buscarNombreCliente(){try{const e=origen+"/api/client?idClient="+$("#idClient").val(),t=await fetch(e);resultado=await t.json(),document.querySelector("#fullname").innerHTML="Cliente: "+resultado.lastname+", "+resultado.firstname}catch(e){console.log(e)}}async function listarEquipos(){try{const e=origen+"/api/equipments?idModel="+getListModel().value,t=await fetch(e),o=await t.json();borrarLista(getListEquipment().querySelectorAll("option")),getListEquipment().appendChild(configurarLista("--Equipo--")),agregarEquipos(o),o.length>0?getListEquipment().disabled=!1:getListEquipment().disabled=!0}catch(e){console.log(e)}}async function listarModelos(){try{const e=origen+"/api/models",t=await fetch(e);agregarModelos(await t.json())}catch(e){console.log(e)}}async function listarMetodosPago(){try{const e=origen+"/api/payment_method",t=await fetch(e);agregarMetodosPago(await t.json())}catch(e){console.log(e)}}function agregarModelos(e){e.forEach(e=>{const{id:t,model_name:o}=e;getListModel().appendChild(createOption(t,o))})}function agregarMetodosPago(e){e.forEach(e=>{const{id:t,name:o}=e;getPaymentMethod().appendChild(createOption(t,o))})}function agregarEquipos(e){e.forEach(e=>{const{id:t,serial_number:o}=e;getListEquipment().appendChild(createOption(t,o))})}function configurarBotonAgregarMedioPago(){getBotonAgregarPago().addEventListener("click",(function(e){e.preventDefault(),AgregarMedioPago()}))}function AgregarMedioPago(){const e=getValueMetodoPago(),t=sale.metodoPagos.find((function(t){return t.id==e})),o=parseInt(getValueMonto());if(""!=getPaymentMethod().value&&0!=getMonto().value){if("Cheque"!=getTextMetodoPago()&&t)alert("Pruebe con otro metodo de pago");else if(pagado+o<=aPagar){const t=new Object;t.idPaymentMethod=e,t.metodo=getTextMetodoPago(),t.amount=o,sale.metodoPagos=[...sale.metodoPagos,t];const a=getTable().querySelector("tbody"),r=createElement("tr");r.appendChild(addColumn(getTextMetodoPago())),r.appendChild(addColumn("$ "+parseInt(getValueMonto()))),r.appendChild(addColumn("")),r.appendChild(addActions()),pagado+=parseInt(getMonto().value),resto=aPagar-pagado,agregarResumen(),a.appendChild(r)}else alert("El monto Pagado supera el monto a pagar");getPaymentMethod().value="",getMonto().value=0}else alert("Debe elegir un Medio de Pago y Monto")}function mostrarPrecio(){aPagar=parseInt(getPrecio().value),resto=aPagar-pagado,agregarResumen()}function getListModel(){return document.querySelector("#modelo")}function getPaymentMethod(){return document.querySelector("#paymentMethod")}function getListEquipment(){return document.querySelector("#idEquipment")}function getBotonAgregarPago(){return document.querySelector("#agregarPago")}function getTable(){return document.querySelector(".resumen")}function getMonto(){return document.querySelector("#amount")}function getPrecio(){return document.querySelector("#price")}function getTotalAPagar(){return document.querySelector("body > div > div.contenedor > form > fieldset:nth-child(2) > table > tfoot > tr > th:nth-child(1)")}function getPagado(){return document.querySelector("body > div > div.contenedor > form > fieldset:nth-child(2) > table > tfoot > tr > th:nth-child(2)")}function getFaltaPagar(){return document.querySelector("body > div > div.contenedor > form > fieldset:nth-child(2) > table > tfoot > tr > th:nth-child(3)")}function getValueMetodoPago(){return getPaymentMethod().value}function getTextMetodoPago(){return getPaymentMethod().options[getPaymentMethod().selectedIndex].text}function getValueMonto(){return getMonto().value}function createElement(e){return document.createElement(e)}function borrarLista(e){e.forEach(e=>{e.remove()})}function configurarLista(e){const t=createOption(0,e);return t.setAttribute("selected",!0),t.disabled=!0,t}function createOption(e,t){const o=createElement("option");return o.value=e,o.textContent=t,o}function addColumn(e){const t=createElement("td");return t.textContent=e,t}function addActions(){const e=createElement("i");e.className="fas fa-minus-circle color-red",e.dataset.idPayment="1";const t=createElement("td");return t.appendChild(e),t}function agregarResumen(){getTotalAPagar().textContent="Total a Pagar: $ "+aPagar,getPagado().textContent="Pagado: $ "+pagado,getFaltaPagar().textContent="Falta Pagar: $ "+resto}async function guardarVenta(){if(var_error=!1,setIdCliente(),setEquipo(),setPrecio(),setFecha(),setGarantia(),setUsuario(),""===sale.idEquipment?($("#error_equipo").addClass("error"),var_error=!0):$("#error_equipo").removeClass("error"),""===sale.price?($("#error_price").addClass("error"),var_error=!0):$("#error_price").removeClass("error"),""===sale.date?($("#error_date").addClass("error"),var_error=!0):$("#error_date").removeClass("error"),resto>0?($("#error_saldo").addClass("error"),var_error=!0):$("#error_saldo").removeClass("error"),!var_error){const e=JSON.stringify(sale);try{const t=origen+"/api/sales",o=await fetch(t,{method:"POST",body:e});await o.json()}catch(e){console.log(e)}}}function setEquipo(){sale.idEquipment=document.querySelector("#idEquipment").value}function setPrecio(){sale.price=document.querySelector("#price").value}function setFecha(){sale.date=document.querySelector("#date").value}function setIdCliente(){sale.idClient=document.querySelector("#idClient").value}function setGarantia(){sale.verified_warranty=document.querySelector("#warranty").checked?1:0}function setUsuario(){sale.idUser=document.querySelector("#idUsuario").value}"/sales/sale"==urlActual&&document.addEventListener("DOMContentLoaded",(function(){iniciarApp()}));